// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User System (SaaS)
model User {
  id        String   @id // Stores Auth Provider ID (e.g. Clerk user_id)
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  // Relations
  procurementRequests ProcurementRequest[]
  rfqs                RFQ[]
  orders              Order[]
  boards              Board[]
  rooms               Room[]
  emailAccounts       EmailAccount[]
  vaultItems          VaultItem[]
  activities          Activity[]

  @@index([workspaceId])
}

model Activity {
  id          String   @id @default(uuid())
  userId      String
  workspaceId String?
  boardId     String?
  type        String   // e.g., "TASK_CREATED", "BOARD_CREATED", etc.
  content     String   // Display message
  metadata    String?  // JSON string for extra data
  createdAt   DateTime @default(now())

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  board     Board?     @relation(fields: [boardId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([workspaceId])
  @@index([boardId])
  @@index([createdAt])
  @@index([userId, createdAt]) // Composite index for user activity feed queries
  @@index([workspaceId, createdAt]) // Composite index for workspace activity queries
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  icon      String?
  color     String?
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  invitations Invitation[]
  boards      Board[]
  activities  Activity[]
}

model Invitation {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  status    String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime
}

// Procurement System
model ProcurementRequest {
  id             String    @id
  userId         String
  name           String
  date           String
  department     String
  warehouse      String?
  relatedTo      String?
  status         String    @default("Pending")
  priority       String    @default("Normal")
  isUrgent       Boolean   @default(false)
  approvalStatus String    @default("Pending")
  rfqSent        Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  items RequestItem[]
  rfqs  RFQ[]

  @@index([userId])
  @@index([status])
}

model RequestItem {
  id          String  @id @default(uuid())
  requestId   String
  itemCode    String
  description String
  quantity    Float
  dueDate     String?
  unitPrice   Float?

  request ProcurementRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
}

model RFQ {
  id          String   @id
  userId      String
  requestId   String?
  date        String
  department  String
  warehouse   String?
  supplier    String
  value       Float    @default(0)
  dueDate     String?
  status      String   @default("Open")
  createdDate String
  relatedTo   String?
  sentToOrder Boolean  @default(false)
  orderId     String?
  unitPrice   Float?
  quantity    Float?
  vatAmount   Float?
  totalExVat  Float?

  user    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  request ProcurementRequest? @relation(fields: [requestId], references: [id])
  items   RFQItem[]
  orders  Order[]

  @@index([userId])
  @@index([requestId])
  @@index([status])
}

model RFQItem {
  id          String  @id @default(uuid())
  rfqId       String
  itemCode    String
  description String
  quantity    Float
  dueDate     String?
  unitPrice   Float?

  rfq RFQ @relation(fields: [rfqId], references: [id], onDelete: Cascade)

  @@index([rfqId])
}

model Order {
  id          String   @id
  userId      String
  rfqId       String?
  requestId   String?
  supplier    String
  department  String
  warehouse   String?
  date        String
  dueDate     String?
  totalValue  Float
  priority    String?
  status      String   @default("Open")
  approvals   String?
  relatedTo   String?

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  rfq   RFQ?        @relation(fields: [rfqId], references: [id])
  items OrderItem[]

  @@index([userId])
  @@index([rfqId])
  @@index([status])
}

model OrderItem {
  id          String  @id @default(uuid())
  orderId     String
  itemCode    String
  description String
  quantity    Float
  dueDate     String?
  unitPrice   Float?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

// Board System
model Board {
  id             String   @id @default(uuid())
  userId         String
  workspaceId    String?
  name           String
  icon           String?
  description    String?
  availableViews String?
  pinnedViews    String?
  columns        String?
  defaultView    String?
  tasks          String   @default("[]") // JSON for flexibility
  type           String   @default("project")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace  Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  cards      Card[]
  activities Activity[]

  @@index([userId])
  @@index([workspaceId])
  @@index([workspaceId, createdAt]) // Composite index for workspace board listing
}

model Card {
  id          String  @id @default(uuid())
  boardId     String
  title       String
  description String?
  columnId    String?

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
}

// Doc/Page System (Notion-like pages)
model DocPage {
  id         String   @id @default(uuid())
  roomId     String?
  boardId    String?
  title      String   @default("Untitled")
  content    String?  // JSON/HTML content
  icon       String?
  coverImage String?
  parentId   String?  // For nested pages
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([roomId])
  @@index([boardId])
  @@index([parentId])
}

// Room/Table System
model Room {
  id        String   @id @default(uuid())
  userId    String
  name      String
  type      String   @default("table")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  rows         Row[]
  columnStores ColumnStore[]

  @@index([userId])
}

model Row {
  id      String @id @default(uuid())
  roomId  String
  content String @default("{}") // JSON for dynamic row data

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
}

model ColumnStore {
  id      String @id @default(uuid())
  roomId  String
  columns String // JSON string of Column[] definitions

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
}

// Email Integration
model EmailAccount {
  id           String   @id @default(uuid())
  userId       String
  provider     String
  email        String
  accessToken  String
  refreshToken String
  tokenExpiry  DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([email, provider])
  @@index([userId])
  @@index([userId, provider]) // Composite index for fetching user accounts by provider
}

// Vault System
model VaultItem {
  id         String   @id @default(uuid())
  userId     String
  title      String
  type       String   // folder, file, note, weblink
  subtitle   String?
  content    String?  // For notes or text content
  metadata   String?  // JSON for file size, mimeType, etc.
  isFavorite Boolean  @default(false)
  folderId   String?  // Parent folder ID
  color      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   VaultItem?  @relation("FolderItems", fields: [folderId], references: [id], onDelete: Cascade)
  children VaultItem[] @relation("FolderItems")

  @@index([userId])
  @@index([folderId])
  @@index([type])
}
