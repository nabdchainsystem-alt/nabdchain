generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id
  email                    String                    @unique
  name                     String?
  avatarUrl                String?
  aiCreditsBalance         Int                       @default(100)
  lastActiveAt             DateTime?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  workspaceId              String?
  role                     String                    @default("member")
  activities               Activity[]
  assignmentsSent          Assignment[]              @relation("AssignmentFrom")
  assignmentsReceived      Assignment[]              @relation("AssignmentTo")
  boards                   Board[]
  conversationParticipants ConversationParticipant[]
  emailAccounts            EmailAccount[]
  messages                 Message[]
  orders                   Order[]
  procurementRequests      ProcurementRequest[]
  rfqs                     RFQ[]
  rooms                    Room[]
  workspace                Workspace?                @relation(fields: [workspaceId], references: [id])
  vaultItems               VaultItem[]
  pagePermissions          UserPagePermission[]
  fileMappings             FileMapping[]
  aiUsageLogs              AIUsageLog[]
  talkTasks                TalkTask[]
  talkReminders            TalkReminder[]
  talkFiles                TalkFile[]
  createdConversations     Conversation[]            @relation("ConversationCreator")
  gtdItems                 GTDItem[]
  quickNotes               QuickNote[]
  items                    Item[]

  @@index([workspaceId])
  @@index([lastActiveAt])
}

model Activity {
  id          String     @id @default(uuid())
  userId      String
  workspaceId String?
  boardId     String?
  type        String
  content     String
  metadata    String?
  createdAt   DateTime   @default(now())
  board       Board?     @relation(fields: [boardId], references: [id])
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  @@index([userId])
  @@index([workspaceId])
  @@index([boardId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([workspaceId, createdAt])
}

model Workspace {
  id          String       @id @default(uuid())
  name        String
  icon        String?
  color       String?
  ownerId     String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  activities  Activity[]
  boards      Board[]
  invitations Invitation[]
  users       User[]
}

model Invitation {
  id          String    @id @default(uuid())
  email       String
  token       String    @unique
  status      String    @default("PENDING")
  workspaceId String
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model ProcurementRequest {
  id             String        @id
  userId         String
  name           String
  date           String
  department     String
  warehouse      String?
  relatedTo      String?
  status         String        @default("Pending")
  priority       String        @default("Normal")
  isUrgent       Boolean       @default(false)
  approvalStatus String        @default("Pending")
  rfqSent        Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  rfqs           RFQ[]
  items          RequestItem[]

  @@index([userId])
  @@index([status])
}

model RequestItem {
  id          String             @id @default(uuid())
  requestId   String
  itemCode    String
  description String
  quantity    Float
  dueDate     String?
  unitPrice   Float?
  request     ProcurementRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
}

model RFQ {
  id          String              @id
  userId      String
  requestId   String?
  date        String
  department  String
  warehouse   String?
  supplier    String
  value       Float               @default(0)
  dueDate     String?
  status      String              @default("Open")
  createdDate String
  relatedTo   String?
  sentToOrder Boolean             @default(false)
  orderId     String?
  unitPrice   Float?
  quantity    Float?
  vatAmount   Float?
  totalExVat  Float?
  orders      Order[]
  request     ProcurementRequest? @relation(fields: [requestId], references: [id])
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       RFQItem[]

  @@index([userId])
  @@index([requestId])
  @@index([status])
}

model RFQItem {
  id          String  @id @default(uuid())
  rfqId       String
  itemCode    String
  description String
  quantity    Float
  dueDate     String?
  unitPrice   Float?
  rfq         RFQ     @relation(fields: [rfqId], references: [id], onDelete: Cascade)

  @@index([rfqId])
}

model Order {
  id         String      @id
  userId     String
  rfqId      String?
  requestId  String?
  supplier   String
  department String
  warehouse  String?
  date       String
  dueDate    String?
  totalValue Float
  priority   String?
  status     String      @default("Open")
  approvals  String?
  relatedTo  String?
  rfq        RFQ?        @relation(fields: [rfqId], references: [id])
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items      OrderItem[]

  @@index([userId])
  @@index([rfqId])
  @@index([status])
}

model OrderItem {
  id          String  @id @default(uuid())
  orderId     String
  itemCode    String
  description String
  quantity    Float
  dueDate     String?
  unitPrice   Float?
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Board {
  id             String     @id @default(uuid())
  userId         String
  workspaceId    String?
  parentId       String?    // For sub-board hierarchy
  name           String
  icon           String?
  description    String?
  availableViews String?
  pinnedViews    String?
  columns        String?
  defaultView    String?
  tasks          String     @default("[]")
  type           String     @default("project")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  activities     Activity[]
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace      Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  cards          Card[]
  parent         Board?     @relation("BoardHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children       Board[]    @relation("BoardHierarchy")

  @@index([userId])
  @@index([workspaceId])
  @@index([parentId])
  @@index([workspaceId, createdAt])
}

model Card {
  id          String  @id @default(uuid())
  boardId     String
  title       String
  description String?
  columnId    String?
  board       Board   @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
}

model DocPage {
  id         String   @id @default(uuid())
  roomId     String?
  boardId    String?
  title      String   @default("Untitled")
  content    String?
  icon       String?
  coverImage String?
  parentId   String?
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([roomId])
  @@index([boardId])
  @@index([parentId])
}

model Room {
  id           String        @id @default(uuid())
  userId       String
  name         String
  type         String        @default("table")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  columnStores ColumnStore[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  rows         Row[]

  @@index([userId])
}

model Row {
  id      String @id @default(uuid())
  roomId  String
  content String @default("{}")
  room    Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
}

model ColumnStore {
  id      String @id @default(uuid())
  roomId  String
  columns String
  room    Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
}

model EmailAccount {
  id           String   @id @default(uuid())
  userId       String
  provider     String
  email        String
  accessToken  String
  refreshToken String
  tokenExpiry  DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([email, provider])
  @@index([userId])
  @@index([userId, provider])
}

model TeamConnection {
  id         String   @id @default(uuid())
  senderId   String
  receiverId String
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
}

model Assignment {
  id                 String    @id @default(uuid())
  sourceBoardId      String
  sourceRowId        String
  sourceTaskData     String
  assignedFromUserId String
  assignedToUserId   String
  isViewed           Boolean   @default(false)
  viewedAt           DateTime?
  createdAt          DateTime  @default(now())
  copiedBoardId      String?
  copiedRowId        String?
  assignedFromUser   User      @relation("AssignmentFrom", fields: [assignedFromUserId], references: [id], onDelete: Cascade)
  assignedToUser     User      @relation("AssignmentTo", fields: [assignedToUserId], references: [id], onDelete: Cascade)

  @@index([assignedToUserId])
  @@index([assignedToUserId, isViewed])
  @@index([createdAt])
}

model VaultItem {
  id         String      @id @default(uuid())
  userId     String
  title      String
  type       String
  subtitle   String?
  content    String?
  metadata   String?
  isFavorite Boolean     @default(false)
  isDeleted  Boolean     @default(false)
  deletedAt  DateTime?
  folderId   String?
  color      String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  parent     VaultItem?  @relation("FolderItems", fields: [folderId], references: [id], onDelete: Cascade)
  children   VaultItem[] @relation("FolderItems")
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([folderId])
  @@index([type])
  @@index([isDeleted])
}

model Conversation {
  id           String                    @id @default(uuid())
  type         String
  name         String?
  status       String                    @default("active") // active, closed, deleted
  creatorId    String?                   // Optional for legacy conversations
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]
  creator      User?                     @relation("ConversationCreator", fields: [creatorId], references: [id])

  @@index([type])
  @@index([status])
  @@index([updatedAt])
  talkTasks    TalkTask[]
  talkReminders TalkReminder[]
  talkFiles    TalkFile[]
}

model TalkTask {
  id             String       @id @default(uuid())
  conversationId String
  creatorId      String
  name           String
  status         String       @default("pending") // pending, in_progress, completed
  boardId        String?      // If sent to a board
  boardName      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  creator        User         @relation(fields: [creatorId], references: [id])
  files          TalkFile[]

  @@index([conversationId])
  @@index([creatorId])
}

model TalkReminder {
  id             String       @id @default(uuid())
  conversationId String
  creatorId      String
  text           String
  dueDate        DateTime
  completed      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  creator        User         @relation(fields: [creatorId], references: [id])

  @@index([conversationId])
  @@index([creatorId])
}

model TalkFile {
  id             String       @id @default(uuid())
  conversationId String
  uploaderId     String
  taskId         String?
  name           String
  type           String
  url            String?
  size           Int?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  uploader       User         @relation(fields: [uploaderId], references: [id])
  task           TalkTask?    @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([conversationId])
  @@index([uploaderId])
  @@index([taskId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([conversationId, createdAt])
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  lastReadAt     DateTime?
  joinedAt       DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model FeatureFlag {
  id        String   @id @default(uuid())
  key       String   @unique
  enabled   Boolean  @default(true)
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([key])
}

model UserPagePermission {
  id        String   @id @default(uuid())
  userId    String
  pageKey   String
  enabled   Boolean  @default(true)
  updatedAt DateTime @updatedAt
  updatedBy String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pageKey])
  @@index([userId])
}

model FileMapping {
  id             String   @id @default(uuid())
  userId         String
  fileName       String
  originalSchema String   // Raw headers/columns from file
  mappedSchema   String   // AI-generated normalized mapping JSON
  dataTypes      String   // Detected data types JSON
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AIUsageLog {
  id          String   @id @default(uuid())
  userId      String
  tier        String   // 'cleaner' | 'worker' | 'thinker'
  creditsUsed Int
  promptType  String   // 'chart' | 'gtd' | 'analysis' | 'upload' | 'general'
  success     Boolean
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// GTD (Getting Things Done) Items for mobile sync
model GTDItem {
  id          String    @id @default(uuid())
  userId      String
  boardId     String    @default("default")
  title       String
  category    String    // inbox, projects, nextActions, waitingFor, scheduled, someday, reference, completed
  scheduledAt DateTime?
  completedAt DateTime?
  notes       String?
  tags        String?   // JSON array
  version     Int       @default(1)
  clientId    String?   // For offline sync
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, category])
  @@index([userId, isDeleted])
  @@unique([userId, clientId])
}

// Quick Notes for mobile
model QuickNote {
  id        String   @id @default(uuid())
  userId    String
  content   String
  tags      String?  // JSON array
  pinned    Boolean  @default(false)
  clientId  String?  // For offline sync
  version   Int      @default(1)
  isDeleted Boolean  @default(false)
  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, pinned])
  @@unique([userId, clientId])
}

// =============================================================================
// COMMENTS SYSTEM
// =============================================================================

model Comment {
  id          String            @id @default(uuid())
  authorId    String
  entityType  String            // 'row', 'board', 'doc', 'task'
  entityId    String
  content     String
  parentId    String?           // For replies/threading
  mentions    String?           // JSON array of user IDs
  attachments String?           // JSON array of attachment objects
  edited      Boolean           @default(false)
  editedAt    DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  reactions   CommentReaction[]
  parent      Comment?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[]         @relation("CommentReplies")

  @@index([authorId])
  @@index([entityType, entityId])
  @@index([parentId])
  @@index([createdAt])
}

model CommentReaction {
  id        String   @id @default(uuid())
  commentId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, emoji])
  @@index([commentId])
  @@index([userId])
}

// =============================================================================
// NOTIFICATIONS SYSTEM
// =============================================================================

model Notification {
  id          String   @id @default(uuid())
  userId      String
  type        String   // 'mention', 'assignment', 'comment', 'status_change', etc.
  title       String
  body        String?
  entityType  String?  // 'board', 'task', 'comment', 'workspace'
  entityId    String?
  entityName  String?
  boardId     String?
  boardName   String?
  actorId     String?
  actorName   String?
  actorAvatar String?
  read        Boolean  @default(false)
  emailSent   Boolean  @default(false)
  pushSent    Boolean  @default(false)
  actionUrl   String?
  metadata    String?  // JSON
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}

model NotificationPreference {
  id                   String  @id @default(uuid())
  userId               String  @unique
  emailEnabled         Boolean @default(true)
  emailMentions        Boolean @default(true)
  emailAssignments     Boolean @default(true)
  emailComments        Boolean @default(true)
  emailDueDates        Boolean @default(true)
  emailStatusChanges   Boolean @default(false)
  emailDigest          String  @default("none") // 'none', 'daily', 'weekly'
  pushEnabled          Boolean @default(true)
  pushMentions         Boolean @default(true)
  pushAssignments      Boolean @default(true)
  pushComments         Boolean @default(true)
  pushDueDates         Boolean @default(true)
  quietHoursEnabled    Boolean @default(false)
  quietHoursStart      String  @default("22:00")
  quietHoursEnd        String  @default("08:00")
  quietHoursTimezone   String  @default("UTC")
  updatedAt            DateTime @updatedAt

  @@index([userId])
}

// =============================================================================
// TIME TRACKING SYSTEM
// =============================================================================

model TimeEntry {
  id          String    @id @default(uuid())
  userId      String
  boardId     String
  taskId      String?
  rowId       String?
  description String?
  startTime   DateTime
  endTime     DateTime?
  duration    Int       @default(0) // in seconds
  billable    Boolean   @default(false)
  hourlyRate  Float?
  tags        String?   // JSON array
  source      String    @default("manual") // 'manual', 'timer', 'import'
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([boardId])
  @@index([taskId])
  @@index([userId, boardId])
  @@index([userId, startTime])
}

// =============================================================================
// TEMPLATES SYSTEM
// =============================================================================

model Template {
  id          String    @id @default(uuid())
  name        String
  description String?
  category    String    // 'project_management', 'marketing', 'sales', etc.
  subcategory String?
  thumbnail   String?
  isPublic    Boolean   @default(false)
  workspaceId String?
  createdById String?
  content     String    // JSON - board structure, columns, rooms
  tags        String?   // JSON array
  usageCount  Int       @default(0)
  rating      Float?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([workspaceId])
  @@index([createdById])
  @@index([category])
  @@index([isPublic])
  @@index([isPublic, category])
}

// =============================================================================
// PORTAL MARKETPLACE ITEMS (Universal Item System)
// =============================================================================

model Item {
  id           String   @id @default(uuid())
  userId       String   // Seller/Owner ID

  // Basic Info
  name         String
  nameAr       String?  // Arabic name for RTL support
  sku          String
  partNumber   String?
  description  String?
  descriptionAr String? // Arabic description

  // Item Classification
  itemType     String   @default("part") // part, consumable, service
  category     String
  subcategory  String?

  // Visibility & Status (Core Logic)
  visibility   String   @default("public") // public, rfq_only, hidden
  status       String   @default("draft")  // draft, active, out_of_stock, archived

  // Pricing
  price        Float
  currency     String   @default("SAR")
  priceUnit    String?  // per_unit, per_kg, per_meter, etc.

  // Inventory
  stock        Int      @default(0)
  minOrderQty  Int      @default(1)
  maxOrderQty  Int?
  leadTimeDays Int?     // Delivery lead time

  // Product Details
  manufacturer String?
  brand        String?
  origin       String?  // Country of origin

  // Specifications (JSON for flexibility)
  specifications String? // JSON: { weight, dimensions, material, etc. }

  // Compatibility (JSON array)
  compatibility String? // JSON: [{ make, model, years }]

  // Packaging Info
  packaging    String?  // JSON: { unitWeight, boxQty, palletQty, etc. }

  // Documents & Media
  images       String?  // JSON array of image URLs
  documents    String?  // JSON array of { name, type, url }

  // Supplier/RFQ Intelligence
  avgResponseTime Int?   // Average response time in hours
  totalQuotes     Int    @default(0)
  successfulOrders Int   @default(0)

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  publishedAt  DateTime? // When item went active & public
  archivedAt   DateTime?

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rfqItems     ItemRFQ[]
  marketplaceRfqs MarketplaceRFQ[]

  @@unique([userId, sku]) // SKU unique per seller
  @@index([userId])
  @@index([userId, status])
  @@index([userId, visibility])
  @@index([status, visibility]) // For marketplace queries
  @@index([category])
  @@index([sku])
  @@index([itemType])
}

// =============================================================================
// MARKETPLACE RFQ INBOX SYSTEM
// =============================================================================

model MarketplaceRFQ {
  id           String   @id @default(uuid())
  rfqNumber    String   @unique // Human-readable: RFQ-2024-0001
  itemId       String
  buyerId      String
  sellerId     String

  // Request Details
  quantity     Int
  specifications String? // JSON: custom specs requested

  // Pricing
  requestedPrice Float?  // Buyer's target price (optional)
  quotedPrice    Float?  // Seller's quoted price
  finalPrice     Float?  // Agreed price after negotiation
  currency       String  @default("SAR")

  // Delivery
  requestedLeadTime Int? // Buyer's requested days
  quotedLeadTime    Int? // Seller's quoted days
  finalLeadTime     Int? // Agreed lead time

  // State Machine
  status       String   @default("new") // new, viewed, responded, negotiation, accepted, rejected, expired

  // Negotiation
  negotiationRound Int   @default(0)
  maxNegotiationRounds Int @default(3)

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  viewedAt     DateTime?
  respondedAt  DateTime?
  lastActionAt DateTime  @default(now())
  expiresAt    DateTime?
  completedAt  DateTime?

  // Flags
  isTestItem   Boolean  @default(false)
  triggeredMarketplacePublish Boolean @default(false)

  // Relations
  item         Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  messages     MarketplaceRFQMessage[]
  events       MarketplaceRFQEvent[]

  @@index([itemId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([sellerId, status])
  @@index([buyerId, status])
  @@index([lastActionAt])
}

model MarketplaceRFQMessage {
  id        String   @id @default(uuid())
  rfqId     String
  senderId  String
  senderType String  // "buyer" or "seller"
  content   String
  contentAr String?
  attachments String?
  offeredPrice    Float?
  offeredLeadTime Int?
  createdAt DateTime @default(now())

  rfq       MarketplaceRFQ @relation(fields: [rfqId], references: [id], onDelete: Cascade)

  @@index([rfqId])
  @@index([rfqId, createdAt])
}

model MarketplaceRFQEvent {
  id        String   @id @default(uuid())
  rfqId     String
  actorId   String
  actorType String
  eventType String
  fromStatus String?
  toStatus   String?
  metadata  String?
  createdAt DateTime @default(now())

  rfq       MarketplaceRFQ @relation(fields: [rfqId], references: [id], onDelete: Cascade)

  @@index([rfqId])
  @@index([eventType])
}

// Legacy ItemRFQ
model ItemRFQ {
  id           String   @id @default(uuid())
  itemId       String
  buyerId      String
  sellerId     String
  quantity     Int
  message      String?
  quotedPrice  Float?
  quotedLeadTime Int?
  responseMessage String?
  respondedAt  DateTime?
  status       String   @default("pending")
  expiresAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  item         Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
}

// Legacy model - keeping for backward compatibility during migration
model PortalProduct {
  id           String   @id @default(uuid())
  userId       String
  name         String
  sku          String
  partNumber   String?
  description  String?
  price        Float
  currency     String   @default("SAR")
  stock        Int      @default(0)
  minOrderQty  Int      @default(1)
  category     String
  manufacturer String?
  brand        String?
  weight       String?
  weightUnit   String   @default("kg")
  dimensions   String?
  material     String?
  status       String   @default("draft") // active, draft, out_of_stock
  image        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([userId, status])
  @@index([sku])
}

// =============================================================================
// MARKETPLACE ORDERS SYSTEM
// =============================================================================

model MarketplaceOrder {
  id           String   @id @default(uuid())
  orderNumber  String   @unique // Human-readable: ORD-2024-0001

  // Parties
  buyerId      String
  sellerId     String

  // Item Reference
  itemId       String
  itemName     String   // Denormalized for display
  itemSku      String   // Denormalized for display
  itemImage    String?  // Denormalized for display

  // RFQ Reference (if created from RFQ)
  rfqId        String?
  rfqNumber    String?  // Denormalized for display

  // Order Details
  quantity     Int
  unitPrice    Float
  totalPrice   Float
  currency     String   @default("SAR")

  // Status State Machine
  status       String   @default("pending_confirmation") // pending_confirmation, confirmed, in_progress, shipped, delivered, cancelled, failed, refunded
  paymentStatus String  @default("unpaid") // unpaid, authorized, paid, refunded
  fulfillmentStatus String @default("not_started") // not_started, packing, out_for_delivery, delivered

  // Source
  source       String   @default("direct_buy") // rfq, direct_buy

  // Shipping Information
  shippingAddress String? // JSON: { name, company, street1, street2, city, state, postalCode, country, phone }
  trackingNumber  String?
  carrier         String?
  estimatedDelivery String?

  // Notes
  buyerNotes   String?
  sellerNotes  String?
  internalNotes String?

  // Buyer Info (denormalized)
  buyerName    String?
  buyerEmail   String?
  buyerCompany String?

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  confirmedAt  DateTime?
  shippedAt    DateTime?
  deliveredAt  DateTime?
  cancelledAt  DateTime?

  @@index([buyerId])
  @@index([sellerId])
  @@index([sellerId, status])
  @@index([buyerId, status])
  @@index([status])
  @@index([orderNumber])
  @@index([itemId])
  @@index([rfqId])
}

model MarketplaceOrderAudit {
  id           String   @id @default(uuid())
  orderId      String
  action       String   // created, confirmed, status_changed, payment_updated, shipped, delivered, cancelled, refunded, note_added, tracking_added
  actor        String   // buyer, seller, system
  actorId      String?
  previousValue String?
  newValue     String?
  metadata     String?  // JSON
  createdAt    DateTime @default(now())

  @@index([orderId])
  @@index([orderId, createdAt])
}
